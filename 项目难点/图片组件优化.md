# ImgPro组件优化

基于不同平台图片替换规则的特殊性，我在这个组件增加了平台的传参，用来匹配不同平台的替换规则。

这些规则有一些是可通用的，比如解决跨域问题替换的url地址是使用了nginx代理。

因此，可以在图片的 `onError` 事件上尝试使用替换解决方案，用来保证图片尽可能加载顺利。

首先我需要手写一个 `promise.any` 函数，（它还没有通过预案）

```jsx
/**
 * promiseAny的polyfill版本
 */

const promiseAny = (promises: Promise<any>[]): Promise<any> => {
  return new Promise((resolve, reject) => {
    const rejectQueue: Error[] = [];

    promises.forEach((promise, index) => {
      promise
        .then((result: any) => {
          resolve(result);
        })
        .catch((error: Error) => {
          rejectQueue.push(error);
          if (rejectQueue.length === promises.length) {
            reject(rejectQueue);
          }
        });
    });
  });
};

export default promiseAny;
```

然后我维护一个函数的数组，它的每个元素都是接受一个string参数的替换规则方法

```jsx
/** 处理图片规则方法的数组 */
export const handleImgMethods = [replaceAgencySrc, ...];
```

然后我写一个方法将这些函数转变成promise的形式

```jsx
/** promise.any处理的promise数组 */
const handleImgPromises = (url: string) => {
  return handleImgMethods.map((method) => {
    return new Promise((resolve, reject) => {
      const newImg = new Image();
      newImg.src = url;
      newImg.onload = function () {
        // @ts-ignore
        if (this.complete) {
          resolve(url);
        }
      };

      newImg.onerror = () => {
        reject();
      };
    });
  });
};
```

最后将替换方案实装

```jsx
/** 图片加载失败时，尝试使用替换方案 */
const handleImgError = (event: any, realImgUrl: string) => {
  // 如果图片url为空，则使用默认图片
  if (!realImgUrl) {
    event.target.src = DefaultImg;
    event.target.onerror = null;
    return;
  }

  promiseAny(handleImgPromises(realImgUrl))
    .then((url) => {
      event.target.src = url;
    })
    .catch(() => {
      event.target.src = DefaultImg;
    })
    .finally(() => {
      event.target.onerror = null;
    });
};
```

此外，我顺便给图片组件增加了浏览器新增的懒加载方法，由于浏览器并不一定支持，需要判断一下

```jsx
/**
 * 判断浏览器是否支持img懒加载
 */

const supportsLazy = (() => {
  try {
    if ('loading' in HTMLImageElement.prototype) {
      return 'lazy';
    }
    return undefined;
  } catch (error) {
    return undefined;
  }
})();

export default supportsLazy;
```

接下来在 `img` 标签中加入loading属性即可

```jsx
<img ... loading={supportsLazy }
```

懒加载参考 https://www.zhangxinxu.com/wordpress/2019/09/native-img-loading-lazy/